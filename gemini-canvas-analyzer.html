<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Text Metadata Dashboard</title>
    <!-- Load Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Configure Tailwind -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary': '#4f46e5',
                        'secondary': '#10b981',
                        'accent': '#f97316',
                        'bg-dark': '#1f2937',
                        'card-light': '#f3f4f6',
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <style>
        /* Custom scrollbar for aesthetics */
        textarea::-webkit-scrollbar {
            width: 8px;
        }
        textarea::-webkit-scrollbar-thumb {
            background: #9ca3af;
            border-radius: 4px;
        }
        textarea::-webkit-scrollbar-thumb:hover {
            background: #6b7280;
        }
        .dashboard-card {
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        .dashboard-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
    </style>
</head>
<body class="bg-gray-50 font-sans min-h-screen p-4 md:p-8">

    <!-- Main Container -->
    <div class="max-w-6xl mx-auto">
        <header class="text-center mb-10">
            <h1 class="text-4xl font-extrabold text-primary mb-2">Text Context Analyzer</h1>
            <p class="text-gray-500">Paste your text below to generate an analytical dashboard of its metadata.</p>
        </header>

        <!-- Input and Control Area -->
        <div class="mb-10 p-6 bg-white rounded-xl shadow-lg border border-gray-100">
            <label for="text-input" class="block text-lg font-medium text-gray-700 mb-3">Paste Text Here:</label>
            <textarea id="text-input" rows="12" class="w-full p-4 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary transition duration-150 ease-in-out resize-none" placeholder="E.g., Paste a chapter, a poem, a historical letter, or a short document.">It is a truth universally acknowledged, that a single man in possession of a good fortune, must be in want of a wife.

However little known the feelings or views of such a man may be on his first entering a neighbourhood, this truth is so well fixed in the minds of the surrounding families, that he is considered the rightful property of some one or other of their daughters.
</textarea>

            <div class="mt-5 flex justify-center">
                <button id="analyze-button" class="px-8 py-3 text-lg font-semibold text-white bg-primary rounded-full shadow-lg hover:bg-indigo-700 focus:outline-none focus:ring-4 focus:ring-indigo-500 focus:ring-opacity-50 transition duration-150 ease-in-out flex items-center">
                    <svg id="button-icon" class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                    <span>Generate Dashboard</span>
                </button>
            </div>
            
            <!-- Message Box for errors/status -->
            <div id="status-message" class="mt-4 p-3 hidden text-center text-sm rounded-lg" role="alert"></div>
        </div>

        <!-- Dashboard Visualization Area -->
        <h2 class="text-3xl font-bold text-gray-700 mb-6 border-b pb-2">Analysis Dashboard</h2>
        
        <div id="dashboard-container" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
            <!-- Dynamic cards will be injected here -->
            <div id="placeholder-card" class="lg:col-span-3 text-center p-10 bg-gray-100 text-gray-500 rounded-xl shadow-inner">
                <svg class="w-12 h-12 mx-auto mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path></svg>
                <p class="text-lg font-medium">Results will appear here after analysis.</p>
            </div>
        </div>
    </div>

    <!-- JavaScript Logic -->
    <script type="module">
        // Global variables for Firebase configuration (Mandatory for Canvas environment)
        // Note: These are defined globally by the Canvas environment and must be checked for existence.
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        // The LLM API key is handled automatically by the environment if left as an empty string.
        const apiKey = "";
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

        // --- DOM Elements ---
        const textInput = document.getElementById('text-input');
        const analyzeButton = document.getElementById('analyze-button');
        const statusMessage = document.getElementById('status-message');
        const dashboardContainer = document.getElementById('dashboard-container');
        const buttonIcon = document.getElementById('button-icon');

        // --- JSON Schema for Structured Output (Crucial for reliable extraction) ---
        const jsonSchema = {
            type: "OBJECT",
            properties: {
                "author": { "type": "STRING", "description": "The primary author or originator of the text." },
                "dateRange": { "type": "STRING", "description": "The date or time period when the text was created (e.g., '1897' or '1940s-1950s')." },
                "geographicLocation": { "type": "STRING", "description": "The primary location or region relevant to the text's creation or setting." },
                "literaryGenre": { "type": "STRING", "description": "The primary literary or document genre (e.g., 'Gothic Horror Novel', 'Government Report', 'Epic Poem')." },
                "historicalContext": { "type": "STRING", "description": "A brief, concise summary (1-2 descriptive sentences) of the historical context and surrounding environment of the text." }
            },
            required: ["author", "dateRange", "geographicLocation", "literaryGenre", "historicalContext"]
        };

        // --- Utility Functions ---

        /**
         * Shows a status message (success, error, or info).
         * @param {string} message The message to display.
         * @param {'error'|'success'|'info'} type The type of message.
         */
        function showStatus(message, type = 'info') {
            statusMessage.textContent = message;
            statusMessage.classList.remove('hidden', 'bg-red-100', 'text-red-700', 'bg-green-100', 'text-green-700', 'bg-blue-100', 'text-blue-700');
            
            if (type === 'error') {
                statusMessage.classList.add('bg-red-100', 'text-red-700');
            } else if (type === 'success') {
                statusMessage.classList.add('bg-green-100', 'text-green-700');
            } else { // info
                statusMessage.classList.add('bg-blue-100', 'text-blue-700');
            }
        }

        /**
         * Converts the structured JSON data into HTML cards.
         * @param {object} data - The parsed analysis data.
         */
        function renderDashboard(data) {
            // Remove previous content and placeholder
            dashboardContainer.innerHTML = ''; 

            const analysisKeys = {
                author: { title: 'Author/Originator', icon: 'M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z', color: 'bg-primary' },
                dateRange: { title: 'Date/Era', icon: 'M8 7V3m8 4V3m-4 4h4M9 21h6a2 2 0 002-2V7a2 2 0 00-2-2H9a2 2 0 00-2 2v12a2 2 0 002 2z', color: 'bg-secondary' },
                geographicLocation: { title: 'Location (Origin/Setting)', icon: 'M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z', color: 'bg-accent' },
                literaryGenre: { title: 'Genre/Format', icon: 'M12 6.5v8.5a2 2 0 002 2h6', color: 'bg-indigo-500' },
                historicalContext: { title: 'Historical Context', icon: 'M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z', color: 'bg-red-500' }
            };

            const keys = Object.keys(data);
            
            keys.forEach(key => {
                const meta = analysisKeys[key];
                if (!meta) return;

                const value = data[key] || "N/A or Unknown";
                const isHistoricalContext = key === 'historicalContext';
                
                const cardHtml = `
                    <div class="dashboard-card p-6 ${isHistoricalContext ? 'lg:col-span-3' : 'sm:col-span-1'} bg-white rounded-xl shadow-md border border-gray-200">
                        <div class="flex items-center mb-4">
                            <div class="p-3 rounded-full ${meta.color} text-white">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="${meta.icon}"></path></svg>
                            </div>
                            <h3 class="ml-4 text-xl font-bold text-gray-800">${meta.title}</h3>
                        </div>
                        ${isHistoricalContext ? 
                            `<p class="text-gray-600 leading-relaxed text-base">${value}</p>` : 
                            `<p class="text-2xl font-semibold text-gray-900">${value}</p>`
                        }
                    </div>
                `;
                dashboardContainer.innerHTML += cardHtml;
            });
        }


        /**
         * Core function to call the Gemini API.
         * Implements exponential backoff for retries.
         */
        async function fetchWithRetry(payload, maxRetries = 5) {
            let delay = 1000;
            for (let i = 0; i < maxRetries; i++) {
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        // Throw an error to trigger retry logic, except for fatal errors
                        if (response.status >= 400 && response.status < 500 && response.status !== 429) {
                             throw new Error(`API Error: ${response.status} ${response.statusText}`);
                        }
                        throw new Error('Retrying API request...'); // Will be caught and trigger delay/retry
                    }

                    return response.json();
                } catch (error) {
                    if (i === maxRetries - 1) {
                        throw new Error(`Failed to fetch from API after ${maxRetries} attempts.`);
                    }
                    // Implement exponential backoff
                    await new Promise(resolve => setTimeout(resolve, delay));
                    delay *= 2; // Double the delay for the next retry
                }
            }
        }
        
        // --- Event Handlers ---

        analyzeButton.addEventListener('click', async () => {
            const text = textInput.value.trim();

            if (text.length < 50) {
                showStatus('Please enter a substantial text (at least 50 characters) for accurate analysis.', 'error');
                return;
            }

            // UI State: Loading
            analyzeButton.disabled = true;
            analyzeButton.classList.add('opacity-70');
            buttonIcon.classList.add('animate-spin');
            showStatus('Analyzing text and generating dashboard...', 'info');
            dashboardContainer.innerHTML = ''; // Clear previous results

            // System prompt
            const systemPrompt = `You are an expert literary and historical analyst. Your task is to analyze the provided text and extract five key metadata elements based on the content. You MUST respond with a single, valid JSON object that strictly adheres to the provided schema. If any element cannot be determined, use 'Unknown' or 'N/A'. The historical context must be a brief summary of the text's surrounding environment, not just a definition.`;

            // API Payload
            const payload = {
                contents: [{ parts: [{ text: text }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: jsonSchema
                }
            };

            try {
                const result = await fetchWithRetry(payload);
                
                const candidate = result.candidates?.[0];
                if (!candidate || !candidate.content?.parts?.[0]?.text) {
                    throw new Error("Received an empty or malformed response from the model.");
                }

                // The response is a JSON string, which we must parse
                const jsonText = candidate.content.parts[0].text;
                const analysisData = JSON.parse(jsonText);

                // Check for required fields to ensure parsing was successful
                if (!analysisData.author) {
                     throw new Error("Parsed JSON is missing core data fields.");
                }

                renderDashboard(analysisData);
                showStatus('Analysis complete! Dashboard updated.', 'success');

            } catch (error) {
                console.error("Analysis Error:", error);
                showStatus(`Failed to analyze text: ${error.message}. Please check your input or try again.`, 'error');
            } finally {
                // UI State: Finished
                analyzeButton.disabled = false;
                analyzeButton.classList.remove('opacity-70');
                buttonIcon.classList.remove('animate-spin');
            }
        });

        // Initialize display to show the placeholder on load
        document.addEventListener('DOMContentLoaded', () => {
            const initialText = textInput.value.trim();
            if (initialText) {
                // Automatically run analysis on load for the sample text
                analyzeButton.click(); 
            }
        });
        
    </script>
</body>
</html>
